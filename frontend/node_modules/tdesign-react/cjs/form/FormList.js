/**
 * tdesign v1.15.8
 * (c) 2025 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var toConsumableArray = require('../_chunks/dep-ed1250a7.js');
var defineProperty = require('../_chunks/dep-978cf8f4.js');
var slicedToArray = require('../_chunks/dep-5b506c2b.js');
var React = require('react');
var log = require('../_chunks/dep-d85a1598.js');
var form_FormContext = require('./FormContext.js');
var form_hooks_useForm = require('./hooks/useForm.js');
var form_utils_index = require('./utils/index.js');
var get = require('../_chunks/dep-4025eebb.js');
var merge = require('../_chunks/dep-0639eeb7.js');
var set = require('../_chunks/dep-7415991f.js');
var flattenDeep = require('../_chunks/dep-7e14d071.js');
var unset = require('../_chunks/dep-82b2c49a.js');
require('../_chunks/dep-eb3fc11f.js');
require('../_chunks/dep-6228dec3.js');
require('../_chunks/dep-5139f2bd.js');
require('../_chunks/dep-09726eb1.js');
require('../_chunks/dep-6d194bab.js');
require('../_chunks/dep-d9be3c5b.js');
require('../_chunks/dep-67e7a4d7.js');
require('../_chunks/dep-df62c753.js');
require('../_chunks/dep-bbe36ea3.js');
require('../_chunks/dep-2306061f.js');
require('../_chunks/dep-45d27f3b.js');
require('../_chunks/dep-b63856c7.js');
require('../_chunks/dep-7d270a12.js');
require('../_chunks/dep-f0acb1e5.js');
require('../_chunks/dep-66cacecd.js');
require('../_chunks/dep-5253ea18.js');
require('../_chunks/dep-bd7ca811.js');
require('../_chunks/dep-103d03a9.js');
require('../_chunks/dep-5ac0f58d.js');
require('../_chunks/dep-da3e0627.js');
require('../_chunks/dep-97dc1dd1.js');
require('../_chunks/dep-ecfd625d.js');
require('../_chunks/dep-285bc7da.js');
require('../_chunks/dep-47047a18.js');
require('../_chunks/dep-42134b1b.js');
require('../_chunks/dep-84746fd9.js');
require('../_chunks/dep-a135986a.js');
require('../_chunks/dep-1ad3f489.js');
require('../_chunks/dep-52f4b091.js');
require('../_chunks/dep-f34feb94.js');
require('../_chunks/dep-d4e3b201.js');
require('../_chunks/dep-95d5b3c5.js');
require('../_chunks/dep-117a33c2.js');
require('../_chunks/dep-ee2499b0.js');
require('../_chunks/dep-969adff2.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);

function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { defineProperty._defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
var key = 0;
var FormList = function FormList(props) {
  var _useFormContext = form_FormContext.useFormContext(),
    formMapRef = _useFormContext.formMapRef,
    form = _useFormContext.form,
    onFormItemValueChange = _useFormContext.onFormItemValueChange,
    initialDataFromForm = _useFormContext.initialData,
    resetTypeFromContext = _useFormContext.resetType;
  var name = props.name,
    rules = props.rules,
    children = props.children;
  var originalInitialData = props.initialData || get.get(initialDataFromForm, name) || [];
  var storeValue = get.get(form === null || form === void 0 ? void 0 : form.store, name);
  var initialData = storeValue !== null && storeValue !== void 0 ? storeValue : originalInitialData;
  var _useState = React.useState(initialData),
    _useState2 = slicedToArray._slicedToArray(_useState, 2),
    formListValue = _useState2[0],
    setFormListValue = _useState2[1];
  var _useState3 = React.useState(function () {
      return initialData.map(function (data, index) {
        return {
          data: _objectSpread({}, data),
          key: key += 1,
          name: index,
          isListField: true
        };
      });
    }),
    _useState4 = slicedToArray._slicedToArray(_useState3, 2),
    fields = _useState4[0],
    setFields = _useState4[1];
  var formListMapRef = React.useRef(/* @__PURE__ */new Map());
  var formListRef = React.useRef(null);
  var fieldsTaskQueueRef = React.useRef([]);
  var snakeName = [].concat(name).filter(function (item) {
    return item !== void 0;
  }).toString();
  var isMounted = React.useRef(false);
  React.useEffect(function () {
    return function () {
      isMounted.current = false;
    };
  }, []);
  var operation = {
    add: function add(defaultValue, insertIndex) {
      var cloneFields = toConsumableArray._toConsumableArray(fields);
      var index = insertIndex !== null && insertIndex !== void 0 ? insertIndex : cloneFields.length;
      cloneFields.splice(index, 0, {
        key: key += 1,
        name: index,
        isListField: true
      });
      cloneFields.forEach(function (field, index2) {
        return Object.assign(field, {
          name: index2
        });
      });
      setFields(cloneFields);
      var nextFormListValue = toConsumableArray._toConsumableArray(formListValue);
      if (typeof defaultValue !== "undefined") {
        nextFormListValue[index] = defaultValue;
        setFormListValue(nextFormListValue);
      }
      set.set(form === null || form === void 0 ? void 0 : form.store, flattenDeep.flattenDeep([name]), nextFormListValue);
      var fieldValue = form_utils_index.calcFieldValue(name, nextFormListValue);
      requestAnimationFrame(function () {
        onFormItemValueChange === null || onFormItemValueChange === void 0 || onFormItemValueChange(_objectSpread({}, fieldValue));
      });
    },
    remove: function remove(index) {
      var nextFields = fields.filter(function (item) {
        if (Array.isArray(index)) return !index.includes(item.name);
        return item.name !== index;
      }).map(function (field, i) {
        return _objectSpread(_objectSpread({}, field), {}, {
          name: i
        });
      });
      setFields(nextFields);
      var nextFormListValue = formListValue.filter(function (_, idx) {
        return idx !== index;
      });
      setFormListValue(nextFormListValue);
      unset.unset(form === null || form === void 0 ? void 0 : form.store, flattenDeep.flattenDeep([name, index]));
      var fieldValue = form_utils_index.calcFieldValue(name, nextFormListValue);
      requestAnimationFrame(function () {
        onFormItemValueChange === null || onFormItemValueChange === void 0 || onFormItemValueChange(_objectSpread({}, fieldValue));
      });
    },
    move: function move(from, to) {
      var cloneFields = toConsumableArray._toConsumableArray(fields);
      var fromItem = _objectSpread({}, cloneFields[from]);
      var toItem = _objectSpread({}, cloneFields[to]);
      cloneFields[to] = fromItem;
      cloneFields[from] = toItem;
      set.set(form === null || form === void 0 ? void 0 : form.store, name, []);
      setFields(cloneFields);
    }
  };
  function setListFields(fieldData, callback, originData) {
    setFields(fieldData.map(function (_, index) {
      return {
        key: key += 1,
        name: index,
        isListField: true
      };
    }));
    fieldsTaskQueueRef.current.push({
      callback: callback,
      fieldData: fieldData,
      originData: originData
    });
  }
  React.useEffect(function () {
    if (!name || !formMapRef) return;
    formMapRef.current.set(name, formListRef);
    return function () {
      formMapRef.current["delete"](name);
    };
  }, [snakeName]);
  React.useEffect(function () {
    toConsumableArray._toConsumableArray(formListMapRef.current.values()).forEach(function (formItemRef) {
      if (!formItemRef.current) return;
      var _formItemRef$current = formItemRef.current,
        name2 = _formItemRef$current.name,
        isUpdated = _formItemRef$current.isUpdated;
      if (isUpdated) return;
      var data = get.get(formListValue, name2);
      formItemRef.current.setField({
        value: data,
        status: "not"
      });
    });
  }, [formListValue]);
  React.useEffect(function () {
    var _form$getInternalHook, _form$getInternalHook2;
    if (!isMounted.current) {
      isMounted.current = true;
      return;
    }
    form === null || form === void 0 || (_form$getInternalHook = form.getInternalHooks) === null || _form$getInternalHook === void 0 || (_form$getInternalHook = _form$getInternalHook.call(form, form_hooks_useForm.HOOK_MARK)) === null || _form$getInternalHook === void 0 || (_form$getInternalHook2 = _form$getInternalHook.notifyWatch) === null || _form$getInternalHook2 === void 0 || _form$getInternalHook2.call(_form$getInternalHook, name);
    Promise.resolve().then(function () {
      if (!fieldsTaskQueueRef.current.length) return;
      var currentQueue = fieldsTaskQueueRef.current.pop();
      var fieldData = currentQueue.fieldData,
        callback = currentQueue.callback,
        originData = currentQueue.originData;
      toConsumableArray._toConsumableArray(formListMapRef.current.values()).forEach(function (formItemRef) {
        if (!formItemRef.current) return;
        var itemName = formItemRef.current.name;
        var data = get.get(fieldData, itemName);
        callback(formItemRef, data);
      });
      if (!formMapRef || !formMapRef.current) return;
      toConsumableArray._toConsumableArray(formMapRef.current.values()).forEach(function (formItemRef) {
        if (!formItemRef.current) return;
        var _formItemRef$current2 = formItemRef.current,
          itemName = _formItemRef$current2.name,
          isFormList = _formItemRef$current2.isFormList;
        if (String(itemName) === String(name) || !isFormList) return;
        var data = get.get(originData, itemName);
        if (data) callback(formItemRef, data);
      });
    });
  }, [form, snakeName, fields, formMapRef]);
  React.useImperativeHandle(formListRef, function () {
    return {
      name: name,
      isFormList: true,
      formListMapRef: formListMapRef,
      getValue: function getValue() {
        var formListValue2 = [];
        toConsumableArray._toConsumableArray(formListMapRef.current.values()).forEach(function (formItemRef) {
          if (!formItemRef.current) return;
          var _formItemRef$current3 = formItemRef.current,
            name2 = _formItemRef$current3.name,
            getValue = _formItemRef$current3.getValue;
          var fieldValue = form_utils_index.calcFieldValue(name2, getValue());
          merge.merge(formListValue2, fieldValue);
        });
        return formListValue2;
      },
      validate: function validate() {
        var trigger = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : "all";
        var resultList = [];
        var validates = toConsumableArray._toConsumableArray(formListMapRef.current.values()).map(function (formItemRef) {
          var _formItemRef$current4, _formItemRef$current5;
          return formItemRef === null || formItemRef === void 0 || (_formItemRef$current4 = formItemRef.current) === null || _formItemRef$current4 === void 0 || (_formItemRef$current5 = _formItemRef$current4.validate) === null || _formItemRef$current5 === void 0 ? void 0 : _formItemRef$current5.call(_formItemRef$current4, trigger);
        });
        return new Promise(function (resolve) {
          Promise.all(validates).then(function (validateResult) {
            validateResult.forEach(function (result) {
              var errorValue = Object.values(result)[0];
              merge.merge(resultList, errorValue);
            });
            var errorItems = validateResult.filter(function (item) {
              return Object.values(item)[0] !== true;
            });
            if (errorItems.length) {
              resolve(defineProperty._defineProperty({}, snakeName, resultList));
            } else {
              resolve(defineProperty._defineProperty({}, snakeName, true));
            }
          });
        });
      },
      setValue: function setValue(fieldData, originalData) {
        setListFields(fieldData, function (formItemRef, data) {
          var _formItemRef$current6, _formItemRef$current7;
          formItemRef === null || formItemRef === void 0 || (_formItemRef$current6 = formItemRef.current) === null || _formItemRef$current6 === void 0 || (_formItemRef$current7 = _formItemRef$current6.setValue) === null || _formItemRef$current7 === void 0 || _formItemRef$current7.call(_formItemRef$current6, data);
        }, originalData);
      },
      setField: function setField(fieldData, originalData) {
        var value = fieldData.value,
          status = fieldData.status;
        setListFields(value, function (formItemRef, data) {
          var _formItemRef$current8, _formItemRef$current9;
          formItemRef === null || formItemRef === void 0 || (_formItemRef$current8 = formItemRef.current) === null || _formItemRef$current8 === void 0 || (_formItemRef$current9 = _formItemRef$current8.setField) === null || _formItemRef$current9 === void 0 || _formItemRef$current9.call(_formItemRef$current8, {
            value: data,
            status: status
          });
        }, originalData);
      },
      resetField: function resetField(type) {
        var resetType = type || resetTypeFromContext;
        if (resetType === "initial") {
          setFormListValue(originalInitialData);
          var newFields = originalInitialData.map(function (data, index) {
            return {
              data: _objectSpread({}, data),
              key: key += 1,
              name: index,
              isListField: true
            };
          });
          setFields(newFields);
          set.set(form === null || form === void 0 ? void 0 : form.store, flattenDeep.flattenDeep([name]), originalInitialData);
          requestAnimationFrame(function () {
            toConsumableArray._toConsumableArray(formListMapRef.current.values()).forEach(function (formItemRef) {
              if (!formItemRef.current) return;
              var itemName = formItemRef.current.name;
              var itemValue = get.get(originalInitialData, itemName);
              if (itemValue !== void 0) {
                formItemRef.current.setField({
                  value: itemValue,
                  status: "not"
                });
              }
            });
          });
        } else {
          toConsumableArray._toConsumableArray(formListMapRef.current.values()).forEach(function (formItemRef) {
            var _formItemRef$current0, _formItemRef$current1;
            formItemRef === null || formItemRef === void 0 || (_formItemRef$current0 = formItemRef.current) === null || _formItemRef$current0 === void 0 || (_formItemRef$current1 = _formItemRef$current0.resetField) === null || _formItemRef$current1 === void 0 || _formItemRef$current1.call(_formItemRef$current0);
          });
          fieldsTaskQueueRef.current = [];
          setFormListValue([]);
          setFields([]);
          unset.unset(form === null || form === void 0 ? void 0 : form.store, flattenDeep.flattenDeep([name]));
        }
      },
      setValidateMessage: function setValidateMessage(fieldData) {
        toConsumableArray._toConsumableArray(formListMapRef.current.values()).forEach(function (formItemRef) {
          var _formItemRef$current10, _formItemRef$current11;
          if (!formItemRef.current) return;
          var name2 = formItemRef.current.name;
          var data = get.get(fieldData, name2);
          formItemRef === null || formItemRef === void 0 || (_formItemRef$current10 = formItemRef.current) === null || _formItemRef$current10 === void 0 || (_formItemRef$current11 = _formItemRef$current10.setValidateMessage) === null || _formItemRef$current11 === void 0 || _formItemRef$current11.call(_formItemRef$current10, data);
        });
      },
      resetValidate: function resetValidate() {
        toConsumableArray._toConsumableArray(formListMapRef.current.values()).forEach(function (formItemRef) {
          var _formItemRef$current12, _formItemRef$current13;
          formItemRef === null || formItemRef === void 0 || (_formItemRef$current12 = formItemRef.current) === null || _formItemRef$current12 === void 0 || (_formItemRef$current13 = _formItemRef$current12.resetValidate) === null || _formItemRef$current13 === void 0 || _formItemRef$current13.call(_formItemRef$current12);
        });
      }
    };
  });
  if (typeof children !== "function") {
    log.log.error("Form", "FormList's children must be a function!");
    return null;
  }
  return /* @__PURE__ */React__default["default"].createElement(form_FormContext.FormListContext.Provider, {
    value: {
      name: name,
      rules: rules,
      formListMapRef: formListMapRef,
      initialData: initialData,
      form: form
    }
  }, children(fields, operation));
};
FormList.displayName = "FormList";

exports["default"] = FormList;
//# sourceMappingURL=FormList.js.map
